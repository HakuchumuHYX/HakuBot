from nonebot import on_command
from nonebot.adapters.onebot.v11 import Bot, Event, GroupMessageEvent, MessageSegment, Message, MessageEvent
from nonebot.exception import FinishedException
from nonebot.log import logger
from nonebot.params import CommandArg
from nonebot.permission import SUPERUSER

# å¯¼å…¥æ¸²æŸ“å‡½æ•°
from .render import render_sign_image_v2
from .message import message_sign

import random
import json
from datetime import date
from pathlib import Path
from typing import Dict, Any, Optional

# å¯¼å…¥ç®¡ç†æ¨¡å—
from ..plugin_manager.enable import is_plugin_enabled
from ..utils.common import create_exact_command_rule

# --- é…ç½® ---
DATA_FILE = Path("data/draw_lots/records.json")
# ç¼“å­˜ç›®å½•
CACHE_DIR = Path("data/draw_lots/cache")

# ç¡®ä¿ç›®å½•å­˜åœ¨
DATA_FILE.parent.mkdir(parents=True, exist_ok=True)
CACHE_DIR.mkdir(parents=True, exist_ok=True)

# æ°´å°è®¾ç½®
WATERMARK_TEXT = "Generated by HakuBot"


# --- æ•°æ®æ“ä½œå‡½æ•° ---

def load_records() -> Dict[str, Dict[str, Any]]:
    """åŠ è½½æŠ½ç­¾è®°å½•"""
    if DATA_FILE.exists():
        with open(DATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}


def save_records(records: Dict[str, Dict[str, Any]]):
    """ä¿å­˜æŠ½ç­¾è®°å½•"""
    with open(DATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(records, f, ensure_ascii=False, indent=2)


def get_user_record(user_id: str) -> Optional[int]:
    """
    è·å–ç”¨æˆ·ä»Šå¤©çš„æŠ½ç­¾è®°å½• ID
    è¿”å›: int (index) æˆ– None (æœªæŠ½)
    -1 ä»£è¡¨ç©ºç­¾
    """
    records = load_records()
    today = str(date.today())

    user_data = records.get(user_id)
    if user_data and user_data.get("date") == today:
        return user_data.get("sign_index")
    return None


def save_user_record(user_id: str, sign_index: int):
    """ä¿å­˜ç”¨æˆ·ä»Šå¤©çš„æŠ½ç­¾è®°å½• ID"""
    records = load_records()
    today = str(date.today())
    records[user_id] = {
        "date": today,
        "sign_index": sign_index
    }
    save_records(records)


async def get_or_render_image(sign_index: int, force_refresh: bool = False) -> bytes:
    """
    è·å–å›¾ç‰‡ï¼šä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼Œæ²¡æœ‰åˆ™æ¸²æŸ“å¹¶ä¿å­˜
    :param sign_index: ç­¾æ–‡ç´¢å¼•ï¼Œ-1 è¡¨ç¤ºç©ºç­¾
    :param force_refresh: æ˜¯å¦å¼ºåˆ¶é‡æ–°æ¸²æŸ“ï¼ˆè¦†ç›–ç¼“å­˜ï¼‰
    """
    # 1. ç¡®å®šç¼“å­˜æ–‡ä»¶å
    if sign_index == -1:
        cache_file = CACHE_DIR / "empty.png"
        sign_content = "ç©ºç­¾"
    else:
        # ç¡®ä¿ index åœ¨èŒƒå›´å†…
        if 0 <= sign_index < len(message_sign):
            cache_file = CACHE_DIR / f"{sign_index}.png"
            sign_content = message_sign[sign_index]
        else:
            # å¼‚å¸¸æƒ…å†µï¼Œå›è½åˆ°ç©ºç­¾
            cache_file = CACHE_DIR / "error.png"
            sign_content = "ç©ºç­¾"

    # 2. æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ (å¦‚æœä¸æ˜¯å¼ºåˆ¶åˆ·æ–°)
    if not force_refresh and cache_file.exists():
        logger.debug(f"Draw lots: Cache hit for index {sign_index}")
        return cache_file.read_bytes()

    # 3. æ¸²æŸ“æ–°å›¾ç‰‡
    logger.info(f"Draw lots: Rendering image for index {sign_index} (Force: {force_refresh})")
    img_bytes = await render_sign_image_v2(sign_content, sign_index, WATERMARK_TEXT)

    # 4. å†™å…¥ç¼“å­˜
    try:
        with open(cache_file, "wb") as f:
            f.write(img_bytes)
    except Exception as e:
        logger.error(f"Draw lots: Failed to save cache: {e}")

    return img_bytes


# --- å“åº”å¤„ç†å™¨ ---

command = on_command('æŠ½ç­¾', priority=6, rule=create_exact_command_rule("æŠ½ç­¾"))


@command.handle()
async def lq_(bot: Bot, event: MessageEvent):
    user_id = str(event.user_id)

    # ç¾¤èŠæƒé™æ£€æŸ¥
    if isinstance(event, GroupMessageEvent):
        if not is_plugin_enabled("draw_lots", str(event.group_id), user_id):
            await command.finish("æŠ½ç­¾åŠŸèƒ½å½“å‰å·²è¢«ç¦ç”¨")

    sign_index = -1
    is_retry = False

    # æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æŠ½è¿‡
    record_index = get_user_record(user_id)

    if record_index is not None:
        sign_index = record_index
        is_retry = True
    else:
        # æŠ½ç­¾é€»è¾‘
        a = random.randint(0, 100)
        if a >= 5:  # 95% æ¦‚ç‡æŠ½ä¸­æ­£ç­¾
            # éšæœºé€‰å–ä¸€ä¸ª index
            sign_index = random.randint(0, len(message_sign) - 1)
        else:
            sign_index = -1  # ç©ºç­¾ä»£ç 

        save_user_record(user_id, sign_index)

    # æ„å»ºæ¶ˆæ¯
    msg = Message()
    # æ·»åŠ å›å¤å¼•ç”¨
    msg.append(MessageSegment.reply(event.message_id))

    # æç¤ºè¯­
    if is_retry:
        msg.append("ä½ ä»Šå¤©å·²ç»æŠ½è¿‡ç­¾å•¦ï¼Œè¿™æ˜¯ä½ ä»Šå¤©çš„ç­¾æ–‡ï¼š\n")

    # è·å–/ç”Ÿæˆå›¾ç‰‡å¹¶å‘é€
    try:
        img_bytes = await get_or_render_image(sign_index)
        msg.append(MessageSegment.image(img_bytes))
        await command.finish(msg, at_sender=True)
    except FinishedException:
        raise
    except Exception as e:
        logger.error(f"æŠ½ç­¾å¤„ç†å¤±è´¥: {e}")
        # é™çº§æ–‡æœ¬
        content = "ç©ºç­¾" if sign_index == -1 else message_sign[sign_index]
        await command.finish(f"å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œç­¾æ–‡å†…å®¹ï¼š\n{content}", at_sender=True)


# --- ç¼“å­˜ç®¡ç†å‘½ä»¤ ---

gen_cache_cmd = on_command("åˆ·æ–°ç­¾æ–‡ç¼“å­˜", permission=SUPERUSER, priority=1, block=True)


@gen_cache_cmd.handle()
async def _(bot: Bot, event: Event, args: Message = CommandArg()):
    arg_text = args.extract_plain_text().strip()

    # æƒ…å†µ1ï¼šæŒ‡å®šäº†åºå· (ä¾‹å¦‚ "åˆ·æ–°ç­¾æ–‡ç¼“å­˜ 1")
    if arg_text:
        try:
            n = int(arg_text)

            # å®šä¹‰ 0 ä¸ºç©ºç­¾ï¼Œ1-N ä¸ºå¯¹åº”ç­¾æ–‡
            if n == 0:
                target_idx = -1
                label = "ç©ºç­¾"
            else:
                target_idx = n - 1
                label = f"ç¬¬{n}ç•ª"

            # èŒƒå›´æ£€æŸ¥
            if target_idx != -1 and not (0 <= target_idx < len(message_sign)):
                await gen_cache_cmd.finish(f"âŒ åºå·é”™è¯¯ï¼šè¯·è¾“å…¥ 0 (ç©ºç­¾) æˆ– 1-{len(message_sign)} ä¹‹é—´çš„æ•°å­—ã€‚")

            await gen_cache_cmd.send(f"ğŸ¨ æ­£åœ¨å¼ºåˆ¶é‡æ–°æ¸²æŸ“ {label}...")

            # å¼ºåˆ¶åˆ·æ–°
            await get_or_render_image(target_idx, force_refresh=True)

            await gen_cache_cmd.finish(f"âœ… {label} æ¸²æŸ“å®Œæˆå¹¶å·²æ›´æ–°ç¼“å­˜ï¼")

        except ValueError:
            await gen_cache_cmd.finish("âŒ å‚æ•°é”™è¯¯ï¼Œè¯·è¾“å…¥æ•°å­—åºå·ã€‚")

    # æƒ…å†µ2ï¼šæœªæŒ‡å®šåºå· (ç”Ÿæˆå…¨éƒ¨)
    else:
        await gen_cache_cmd.send("ğŸš€ å¼€å§‹æ£€æŸ¥å¹¶è¡¥å……ç­¾æ–‡ç¼“å­˜...")

        success_count = 0
        total = len(message_sign)

        try:
            # 1. æ£€æŸ¥ç©ºç­¾ (force_refresh=False, ä»…å½“ä¸å­˜åœ¨æ—¶ç”Ÿæˆ)
            await get_or_render_image(-1, force_refresh=False)

            # 2. æ£€æŸ¥æ‰€æœ‰æ­£ç­¾
            for i in range(total):
                if (i + 1) % 10 == 0:
                    logger.info(f"[Draw Lots] è¿›åº¦: {i + 1}/{total}")

                # force_refresh=False: ä»…ç”Ÿæˆç¼ºå¤±çš„ï¼Œè·³è¿‡å·²å­˜åœ¨çš„
                await get_or_render_image(i, force_refresh=False)
                success_count += 1

            await gen_cache_cmd.finish(
                f"âœ… ç¼“å­˜æ£€æŸ¥å®Œæ¯•ï¼\nç¼“å­˜ç›®å½•: {CACHE_DIR.absolute()}\n(æ³¨æ„ï¼šæ‰¹é‡æ¨¡å¼ä»…ç”Ÿæˆç¼ºå¤±å›¾ç‰‡ï¼Œå¦‚éœ€æ›´æ–°æ ·å¼è¯·ä½¿ç”¨'åˆ·æ–°ç­¾æ–‡ç¼“å­˜ <åºå·>'æŒ‡å®šé‡ç»˜)")

        except Exception as e:
            logger.error(f"ç”Ÿæˆç¼“å­˜æ—¶å‘ç”Ÿé”™è¯¯: {e}")
            await gen_cache_cmd.finish(f"âŒ ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºé”™: {e}")
