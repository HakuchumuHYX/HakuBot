# help.py
import os
from pathlib import Path
from nonebot import get_driver
from nonebot.log import logger

# å°è¯•å¯¼å…¥ htmlrender
try:
    from nonebot_plugin_htmlrender import html_to_pic

    HTMLRENDER_AVAILABLE = True
except ImportError:
    HTMLRENDER_AVAILABLE = False
    logger.warning("æœªæ£€æµ‹åˆ° nonebot_plugin_htmlrenderï¼Œå¸®åŠ©å›¾ç‰‡ç”Ÿæˆå°†ä¸å¯ç”¨")

# ================= é…ç½®å¸¸é‡ =================
# å®šä¹‰ä¿å­˜è·¯å¾„ï¼šå½“å‰å·¥ä½œç›®å½•/data/image_processor/help.png
CACHE_DIR = Path.cwd() / "data" / "image_processor"
HELP_IMG_PATH = CACHE_DIR / "help.png"


# ================= æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ (å†…éƒ¨ä½¿ç”¨) =================
async def _render_help_image() -> bool:
    """å†…éƒ¨å‡½æ•°ï¼šæ‰§è¡Œå®é™…çš„æ¸²æŸ“å’Œä¿å­˜é€»è¾‘"""
    if not HTMLRENDER_AVAILABLE:
        return False

    # è‡ªå®šä¹‰æ°´å°
    custom_watermark = "Generated by HakuBot"

    try:
        # CSS æ ·å¼
        css = """
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 800px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 16px;
            font-weight: 400;
        }

        .content {
            padding: 30px 40px 10px 40px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        .section {
            background: white;
            border-radius: 12px;
            border: 1px solid #edf2f7;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            overflow: hidden;
        }

        .section-title {
            background: #f8f9fa;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 700;
            color: #2d3436;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 18px;
            background: #6c5ce7;
            margin-right: 10px;
            border-radius: 2px;
        }

        .cmd-list {
            padding: 15px 20px;
        }

        .cmd-item {
            display: flex;
            align-items: baseline;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .cmd-item:last-child {
            margin-bottom: 0;
        }

        .cmd {
            font-family: 'Consolas', monospace;
            background: #eef2ff;
            color: #4834d4;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 16px;
            margin-right: 15px;
            white-space: nowrap;
            min-width: 140px;
            text-align: right;
            border: 1px solid #e0e7ff;
        }

        .desc {
            color: #636e72;
            font-size: 15px;
            flex: 1;
        }

        .footer {
            margin-top: 10px;
            padding: 20px 40px;
            background: #f1f8ff;
            border-radius: 12px;
            margin-left: 40px;
            margin-right: 40px;
            border: 1px dashed #74b9ff;
        }

        .tip-title {
            color: #0984e3;
            font-weight: 700;
            margin-bottom: 10px;
            display: block;
        }

        .tip-item {
            color: #576574;
            font-size: 14px;
            margin-bottom: 6px;
            position: relative;
            padding-left: 15px;
        }

        .tip-item::before {
            content: 'â€¢';
            position: absolute;
            left: 0;
            color: #0984e3;
        }

        .watermark {
            text-align: right;
            margin-top: 15px;
            margin-right: 45px;
            margin-bottom: 5px;
            color: #b2bec3;
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 1px;
            font-family: 'Consolas', sans-serif;
        }
        """

        # HTML ç»“æ„
        html = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>{css}</style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>å›¾åƒå¤„ç†å·¥å…·ç®±</h1>
                    <p>Image Processor Plugin</p>
                </div>

                <div class="content">

                    <div class="section">
                        <div class="section-title">GIF & åŠ¨æ€å¤„ç†</div>
                        <div class="cmd-list">
                            <div class="cmd-item">
                                <span class="cmd">imgå€’æ”¾</span>
                                <span class="desc">å°† GIF å€’åºæ’­æ”¾ï¼Œç”Ÿæˆå€’æ”¾æ•ˆæœ</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">img x[å€æ•°]</span>
                                <span class="desc">è°ƒæ•´ GIF æ’­æ”¾é€Ÿåº¦ (0.1 - 5.0å€)</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">imgæ—‹è½¬ [å€é€Ÿ]</span>
                                <span class="desc">è®©å›¾ç‰‡è‡ªè½¬ç”Ÿæˆ GIF åŠ¨ç”» (é»˜è®¤é¡ºæ—¶é’ˆ)</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">imgé¡º/é€†æ—¶é’ˆ</span>
                                <span class="desc">æŒ‡å®šæ–¹å‘æ—‹è½¬ï¼Œæ”¯æŒé™æ€å›¾å’Œ GIF</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">å›¾ç‰‡ç¼–è¾‘</div>
                        <div class="cmd-list">
                            <div class="cmd-item">
                                <span class="cmd">imgcut</span>
                                <span class="desc">æ™ºèƒ½å»é™¤èƒŒæ™¯ (æŠ å›¾)</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">imgé•œåƒ</span>
                                <span class="desc">å›¾ç‰‡æ°´å¹³ç¿»è½¬ (å·¦å³é•œåƒ)</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">imgä¸Šé•œåƒ</span>
                                <span class="desc">å›¾ç‰‡å‚ç›´ç¿»è½¬ (ä¸Šä¸‹é•œåƒ)</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">imgå¯¹ç§°</span>
                                <span class="desc">å–å·¦åŠéƒ¨åˆ†è¿›è¡Œé•œåƒå¯¹ç§°</span>
                            </div>
                            <div class="cmd-item">
                                <span class="cmd">img[æ–¹å‘]å¯¹ç§°</span>
                                <span class="desc">æ”¯æŒ å·¦ / å³ / ä¸Š / ä¸‹ / ä¸­å¿ƒ å¯¹ç§°</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">è§†é¢‘å·¥å…·</div>
                        <div class="cmd-list">
                            <div class="cmd-item">
                                <span class="cmd">imggif</span>
                                <span class="desc">å°†è§†é¢‘è½¬æ¢ä¸º GIF (æ”¯æŒæœ€é•¿ 60 ç§’)</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="footer">
                    <span class="tip-title">ğŸ’¡ ä½¿ç”¨å°è´´å£«</span>
                    <div class="tip-item">æ‰€æœ‰å‘½ä»¤å‡éœ€ [å›å¤] åŒ…å«å›¾ç‰‡æˆ–è§†é¢‘çš„æ¶ˆæ¯æ¥è§¦å‘</div>
                    <div class="tip-item">å¤„ç†å¤§å°ºå¯¸ GIF æˆ–é•¿è§†é¢‘å¯èƒ½éœ€è¦å‡ åç§’ï¼Œè¯·è€å¿ƒç­‰å¾…</div>
                </div>

                <div class="watermark">{custom_watermark}</div>
            </div>
        </body>
        </html>
        """

        # ç¡®ä¿ç›®å½•å­˜åœ¨
        CACHE_DIR.mkdir(parents=True, exist_ok=True)

        # æ¸²æŸ“å›¾ç‰‡
        img_bytes = await html_to_pic(
            html=html,
            viewport={"width": 840, "height": 10}
        )

        # ä¿å­˜åˆ°æŒä¹…åŒ–ç›®å½•
        with open(HELP_IMG_PATH, "wb") as f:
            f.write(img_bytes)

        logger.info(f"å¸®åŠ©å›¾ç‰‡å·²ç”Ÿæˆå¹¶ç¼“å­˜è‡³: {HELP_IMG_PATH}")
        return True

    except Exception as e:
        logger.error(f"HTMLRender ç”Ÿæˆå¸®åŠ©å›¾ç‰‡å¤±è´¥: {e}")
        return False


# ================= Startup Hook =================
@get_driver().on_startup
async def init_help_image():
    """Botå¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆå¸®åŠ©å›¾ç‰‡"""
    logger.info("æ­£åœ¨åˆå§‹åŒ–å›¾ç‰‡å¤„ç†æ’ä»¶å¸®åŠ©èœå•...")
    success = await _render_help_image()
    if not success:
        logger.warning("å¸®åŠ©å›¾ç‰‡åˆå§‹åŒ–å¤±è´¥ï¼Œå°†åœ¨é¦–æ¬¡è°ƒç”¨æ—¶é‡è¯•")


# ================= å¯¹å¤–æ¥å£ =================
async def generate_help_image() -> str:
    """è·å–å¸®åŠ©å›¾ç‰‡è·¯å¾„ï¼ˆä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼‰"""
    # 1. å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œç›´æ¥è¿”å›è·¯å¾„
    if HELP_IMG_PATH.exists():
        return str(HELP_IMG_PATH)

    # 2. å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼ˆå¯åŠ¨æ—¶ç”Ÿæˆå¤±è´¥æˆ–è¢«åˆ é™¤ï¼‰ï¼Œå°è¯•é‡æ–°ç”Ÿæˆ
    logger.info("å¸®åŠ©å›¾ç‰‡ç¼“å­˜ä¸å­˜åœ¨ï¼Œæ­£åœ¨é‡æ–°ç”Ÿæˆ...")
    success = await _render_help_image()

    if success:
        return str(HELP_IMG_PATH)
    else:
        return ""


async def get_help_text() -> str:
    """è·å–çº¯æ–‡æœ¬å¸®åŠ©ä¿¡æ¯ï¼ˆå¤‡ç”¨ï¼‰"""
    return """
ã€å›¾åƒå¤„ç†æ’ä»¶å¸®åŠ©ã€‘

[GIF/åŠ¨ç”»]
â€¢ imgå€’æ”¾ : GIFå€’æ”¾
â€¢ imgx [å€æ•°] : GIFå€é€Ÿ (0.1-5.0)
â€¢ imgæ—‹è½¬ [å€é€Ÿ] : è‡ªè½¬GIF (é»˜è®¤é¡ºæ—¶é’ˆ)
â€¢ imgé€†æ—¶é’ˆ [å€é€Ÿ] : é€†æ—¶é’ˆè‡ªè½¬

[å›¾ç‰‡ç¼–è¾‘]
â€¢ imgcut : AIæ™ºèƒ½æŠ å›¾
â€¢ imgé•œåƒ / imgä¸Šé•œåƒ : æ°´å¹³/å‚ç›´ç¿»è½¬
â€¢ imgå¯¹ç§° / imgå·¦å¯¹ç§° : å·¦åŠé•œåƒ
â€¢ imgå³/ä¸Š/ä¸‹/ä¸­å¿ƒå¯¹ç§° : å…¶å®ƒæ–¹å‘å¯¹ç§°

[è§†é¢‘]
â€¢ imggif : è§†é¢‘è½¬GIF (é™60s)

æç¤ºï¼šè¯·å›å¤åŒ…å«å›¾ç‰‡æˆ–è§†é¢‘çš„æ¶ˆæ¯ä½¿ç”¨ã€‚
"""